<!DOCTYPE html>
<html lang="en-GB">
  <head>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta charset="utf-8">
    <title>Using HAProxy for Ngrok-style domain tunneling  in Nixos with SSL self-renewal enabled - Maikelology</title>
    <link rel="preload" href="/assets/css/main.css" as="style">
    <link rel="stylesheet" href="/assets/css/main.css" media="all">
    <!-- Begin Jekyll SEO tag v2.8.0 -->
<title>Using HAProxy for Ngrok-style domain tunneling in Nixos with SSL self-renewal enabled | Maikelology</title>
<meta name="generator" content="Jekyll v4.4.1" />
<meta property="og:title" content="Using HAProxy for Ngrok-style domain tunneling in Nixos with SSL self-renewal enabled" />
<meta name="author" content="Maikel Frias Mosquea" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Another way to do the same tunneling without Ngrok or any paid service, but this time with autorenewal of the SSL and in a more robust and simple manner." />
<meta property="og:description" content="Another way to do the same tunneling without Ngrok or any paid service, but this time with autorenewal of the SSL and in a more robust and simple manner." />
<link rel="canonical" href="http://localhost:4000/2025/10/14/using-haproxy-for-ngrok-style-domain-tunneling-in-nixos-with-ssl-self-renewal-enabled.html" />
<meta property="og:url" content="http://localhost:4000/2025/10/14/using-haproxy-for-ngrok-style-domain-tunneling-in-nixos-with-ssl-self-renewal-enabled.html" />
<meta property="og:site_name" content="Maikelology" />
<meta property="og:image" content="http://localhost:4000/assets/images/unsplash-1637481687365.jpg" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2025-10-14T00:00:00+02:00" />
<meta name="twitter:card" content="summary_large_image" />
<meta property="twitter:image" content="http://localhost:4000/assets/images/unsplash-1637481687365.jpg" />
<meta property="twitter:title" content="Using HAProxy for Ngrok-style domain tunneling in Nixos with SSL self-renewal enabled" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"Maikel Frias Mosquea"},"dateModified":"2025-10-14T00:00:00+02:00","datePublished":"2025-10-14T00:00:00+02:00","description":"Another way to do the same tunneling without Ngrok or any paid service, but this time with autorenewal of the SSL and in a more robust and simple manner.","headline":"Using HAProxy for Ngrok-style domain tunneling in Nixos with SSL self-renewal enabled","image":"http://localhost:4000/assets/images/unsplash-1637481687365.jpg","mainEntityOfPage":{"@type":"WebPage","@id":"http://localhost:4000/2025/10/14/using-haproxy-for-ngrok-style-domain-tunneling-in-nixos-with-ssl-self-renewal-enabled.html"},"url":"http://localhost:4000/2025/10/14/using-haproxy-for-ngrok-style-domain-tunneling-in-nixos-with-ssl-self-renewal-enabled.html"}</script>
<!-- End Jekyll SEO tag -->

    <link type="application/atom+xml" rel="alternate" href="http://localhost:4000/feed.xml" title="Maikelology" />
  </head>
  <body>
    <header class="site-header">
      <div class="wrapper">
        <nav class="site-nav">
          <a href="/">Home</a>
          <a href="/categories/">Categories</a>
          <a href="/about/">About</a>
        </nav>
        <a class="site-title" href="/">Maikelology</a>
        <a href="/search/" class="search-button" aria-label="Search">
          <svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M9 17C13.4183 17 17 13.4183 17 9C17 4.58172 13.4183 1 9 1C4.58172 1 1 4.58172 1 9C1 13.4183 4.58172 17 9 17Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            <path d="M19 19L14.65 14.65" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
        </a>
      </div>
    </header>

    <main class="page-content">
      <div class="wrapper">
        <article class="post">
  
  <div class="post-featured-image">
    <img src="/assets/images/unsplash-1637481687365.jpg" alt="Using HAProxy for Ngrok-style domain tunneling  in Nixos with SSL self-renewal enabled">
  </div>
  
  
  <header class="post-header">
    <h1 class="post-title">Using HAProxy for Ngrok-style domain tunneling  in Nixos with SSL self-renewal enabled</h1>
    
    <p class="post-excerpt">Another way to do the same tunneling without Ngrok or any paid service,  but this time with autorenewal of the SSL and in a more robust and simple manner. </p>
    
    <div class="post-meta">
      <span class="post-author">Maikel Frias Mosquea</span>
      <span class="post-date">14 Oct 2025</span>
      
      
      
      
      <span class="post-reading-time">10 min read</span>
      
      
    </div>
  </header>

  <div class="post-content">
    <p>I love accessing computers from elsewhere yet hate Ngrok, Tailscale and Zrok with passion so I made a post not long ago about <a href="/pagekite-with-custom-domain-in-nixos-tunneling-without-ngrok-for-free/">how to self-host Pagekite</a> to be able to use your own domain names for this. The problem is how ugly it made my configuration.nix files and how I didn’t manage to write an auto-renewal script. Today I’ve figured how using ACME. HAProxy seems to have the same issue of wanting a single file for all keys but I managed to bypass that one here.</p>

<h1 id="configurationnix">Configuration.nix</h1>

<div class="language-nix highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># Assuming configuration.nix</span>
<span class="p">{</span>
  <span class="c"># Rest of your file</span>
  <span class="nv">imports</span> <span class="o">=</span> <span class="p">[</span>
    <span class="c"># Rest of your imports</span>
    <span class="sx">./haproxy-acme.nix</span>
  <span class="p">]</span>
<span class="p">}</span>
</code></pre></div></div>

<h1 id="server-haproxy-acmenix">Server: haproxy-acme.nix</h1>

<p>Change <code class="language-plaintext highlighter-rouge">serverNames</code> for whatever list of servers you want to add, don’t forget to manually edit the <code class="language-plaintext highlighter-rouge">services.haproxy.config</code> configuration too for your added servernames without SSL, in my case is my zerotier one, accessible on my zerotier network.</p>

<p>The <code class="language-plaintext highlighter-rouge">acme_email</code>variable should point to your var.</p>

<div class="language-nix highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span> <span class="nv">config</span><span class="p">,</span> <span class="nv">pkgs</span><span class="p">,</span> <span class="o">...</span> <span class="p">}:</span>
<span class="kd">let</span>
  <span class="nv">acme_email</span> <span class="o">=</span> <span class="s2">"acme@maikel.dev"</span><span class="p">;</span>
  <span class="c"># Map domains to their backend host:port</span>
  <span class="nv">serverBackends</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">"something_one.maikeladas.es"</span> <span class="o">=</span> <span class="s2">"127.0.0.1:4000"</span><span class="p">;</span> <span class="c"># Phoenix dev server.</span>
    <span class="s2">"something_else.maikeladas.es"</span> <span class="o">=</span> <span class="s2">"thinkpad.zerotier:8080"</span><span class="p">;</span> <span class="c">#Zerotier URL</span>
  <span class="p">};</span>
  <span class="nv">serverNames</span> <span class="o">=</span> <span class="kr">builtins</span><span class="o">.</span><span class="nv">attrNames</span> <span class="nv">serverBackends</span><span class="p">;</span>
  <span class="c"># ACLs</span>
  <span class="nv">aclLines</span> <span class="o">=</span> <span class="kr">builtins</span><span class="o">.</span><span class="nv">concatStringsSep</span> <span class="s2">"</span><span class="se">\n</span><span class="s2">"</span> <span class="p">(</span><span class="kr">map</span> <span class="p">(</span><span class="nv">d</span><span class="p">:</span>
    <span class="kd">let</span> <span class="nv">aclName</span> <span class="o">=</span> <span class="s2">"host_</span><span class="si">${</span><span class="kr">builtins</span><span class="o">.</span><span class="nv">replaceStrings</span> <span class="p">[</span> <span class="s2">"."</span> <span class="p">]</span> <span class="p">[</span> <span class="s2">"_"</span> <span class="p">]</span> <span class="nv">d</span><span class="si">}</span><span class="s2">"</span><span class="p">;</span>
    <span class="kn">in</span> <span class="s2">"  acl </span><span class="si">${</span><span class="nv">aclName</span><span class="si">}</span><span class="s2"> hdr(host) -i </span><span class="si">${</span><span class="nv">d</span><span class="si">}</span><span class="s2">"</span>
  <span class="p">)</span> <span class="nv">serverNames</span><span class="p">);</span>
  <span class="nv">redirectLines</span> <span class="o">=</span> <span class="kr">builtins</span><span class="o">.</span><span class="nv">concatStringsSep</span> <span class="s2">"</span><span class="se">\n</span><span class="s2">"</span> <span class="p">(</span><span class="kr">map</span> <span class="p">(</span><span class="nv">d</span><span class="p">:</span>
    <span class="s2">"  http-request redirect scheme https code 301 if host_</span><span class="si">${</span><span class="kr">builtins</span><span class="o">.</span><span class="nv">replaceStrings</span> <span class="p">[</span> <span class="s2">"."</span> <span class="p">]</span> <span class="p">[</span> <span class="s2">"_"</span> <span class="p">]</span> <span class="nv">d</span><span class="si">}</span><span class="s2">"</span>
  <span class="p">)</span> <span class="nv">serverNames</span><span class="p">);</span>
  <span class="c"># use_backend lines</span>
  <span class="nv">backendLines</span> <span class="o">=</span> <span class="kr">builtins</span><span class="o">.</span><span class="nv">concatStringsSep</span> <span class="s2">"</span><span class="se">\n</span><span class="s2">"</span> <span class="p">(</span><span class="kr">map</span> <span class="p">(</span><span class="nv">d</span><span class="p">:</span>
    <span class="kd">let</span>
      <span class="nv">aclName</span> <span class="o">=</span> <span class="s2">"host_</span><span class="si">${</span><span class="kr">builtins</span><span class="o">.</span><span class="nv">replaceStrings</span> <span class="p">[</span> <span class="s2">"."</span> <span class="p">]</span> <span class="p">[</span> <span class="s2">"_"</span> <span class="p">]</span> <span class="nv">d</span><span class="si">}</span><span class="s2">"</span><span class="p">;</span>
      <span class="nv">backendName</span> <span class="o">=</span> <span class="kr">builtins</span><span class="o">.</span><span class="nv">replaceStrings</span> <span class="p">[</span> <span class="s2">"."</span> <span class="p">]</span> <span class="p">[</span> <span class="s2">"_"</span> <span class="p">]</span> <span class="nv">d</span><span class="p">;</span>
    <span class="kn">in</span> <span class="s2">"  use_backend </span><span class="si">${</span><span class="nv">backendName</span><span class="si">}</span><span class="s2">_app if </span><span class="si">${</span><span class="nv">aclName</span><span class="si">}</span><span class="s2">"</span>
  <span class="p">)</span> <span class="nv">serverNames</span><span class="p">);</span>
  <span class="c"># crt files</span>
  <span class="nv">crtFiles</span> <span class="o">=</span> <span class="kr">builtins</span><span class="o">.</span><span class="nv">concatStringsSep</span> <span class="s2">" "</span> <span class="p">(</span><span class="kr">map</span> <span class="p">(</span><span class="nv">d</span><span class="p">:</span>
    <span class="s2">"crt /var/lib/haproxy/certs/</span><span class="si">${</span><span class="nv">d</span><span class="si">}</span><span class="s2">.pem"</span>
  <span class="p">)</span> <span class="nv">serverNames</span><span class="p">);</span>
  <span class="c"># backend definitions</span>
  <span class="nv">backendDefs</span> <span class="o">=</span> <span class="kr">builtins</span><span class="o">.</span><span class="nv">concatStringsSep</span> <span class="s2">"</span><span class="se">\n</span><span class="s2">"</span> <span class="p">(</span><span class="kr">map</span> <span class="p">(</span><span class="nv">d</span><span class="p">:</span>
    <span class="kd">let</span>
      <span class="nv">backendName</span> <span class="o">=</span> <span class="kr">builtins</span><span class="o">.</span><span class="nv">replaceStrings</span> <span class="p">[</span> <span class="s2">"."</span> <span class="p">]</span> <span class="p">[</span> <span class="s2">"_"</span> <span class="p">]</span> <span class="nv">d</span><span class="p">;</span>
      <span class="nv">backendAddr</span> <span class="o">=</span> <span class="nv">serverBackends</span><span class="o">.</span><span class="p">${</span><span class="nv">d</span><span class="p">};</span>
      <span class="nv">indent</span> <span class="o">=</span> <span class="s2">"    "</span><span class="p">;</span> <span class="c"># 1 tab = 4 spaces</span>
    <span class="kn">in</span> <span class="s2">''</span><span class="err">
</span><span class="s2">      backend </span><span class="si">${</span><span class="nv">backendName</span><span class="si">}</span><span class="s2">_app</span><span class="err">
</span><span class="s2">        mode http</span><span class="err">
</span><span class="s2">        server </span><span class="si">${</span><span class="nv">backendName</span><span class="si">}</span><span class="s2">_1 </span><span class="si">${</span><span class="nv">backendAddr</span><span class="si">}</span><span class="s2"> check inter 2s fall 3 rise 2</span><span class="err">
</span><span class="s2">        errorfiles customerrors</span><span class="err">
</span><span class="s2">    ''</span>
  <span class="p">)</span> <span class="nv">serverNames</span><span class="p">);</span>
<span class="kn">in</span> <span class="p">{</span>
  <span class="c"># SSL certificates for HAProxy</span>
  <span class="nv">security</span><span class="o">.</span><span class="nv">acme</span> <span class="o">=</span> <span class="p">{</span>
    <span class="nv">acceptTerms</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
    <span class="nv">defaults</span><span class="o">.</span><span class="nv">email</span> <span class="o">=</span> <span class="nv">acme_email</span><span class="p">;</span>
    <span class="nv">certs</span> <span class="o">=</span> <span class="kr">builtins</span><span class="o">.</span><span class="nv">listToAttrs</span> <span class="p">(</span><span class="kr">map</span> <span class="p">(</span><span class="nv">domain</span><span class="p">:</span> <span class="p">{</span>
      <span class="nv">name</span> <span class="o">=</span> <span class="nv">domain</span><span class="p">;</span>
      <span class="nv">value</span> <span class="o">=</span> <span class="p">{</span>
        <span class="nv">webroot</span> <span class="o">=</span> <span class="s2">"/var/lib/acme/acme-challenge"</span><span class="p">;</span>
        <span class="nv">group</span> <span class="o">=</span> <span class="s2">"haproxy"</span><span class="p">;</span>
        <span class="nv">postRun</span> <span class="o">=</span> <span class="s2">''</span><span class="err">
</span><span class="s2">          mkdir -p /var/lib/haproxy/certs</span><span class="err">
</span><span class="s2">          cat /var/lib/acme/</span><span class="si">${</span><span class="nv">domain</span><span class="si">}</span><span class="s2">/fullchain.pem \</span><span class="err">
</span><span class="s2">            /var/lib/acme/</span><span class="si">${</span><span class="nv">domain</span><span class="si">}</span><span class="s2">/key.pem \</span><span class="err">
</span><span class="s2">            &gt; /var/lib/haproxy/certs/</span><span class="si">${</span><span class="nv">domain</span><span class="si">}</span><span class="s2">.pem</span><span class="err">
</span><span class="s2">          chown root:haproxy /var/lib/haproxy/certs/</span><span class="si">${</span><span class="nv">domain</span><span class="si">}</span><span class="s2">.pem</span><span class="err">
</span><span class="s2">          chmod 0640 /var/lib/haproxy/certs/</span><span class="si">${</span><span class="nv">domain</span><span class="si">}</span><span class="s2">.pem</span><span class="err">
</span><span class="s2">        ''</span><span class="p">;</span>
      <span class="p">};</span>
    <span class="p">})</span> <span class="nv">serverNames</span><span class="p">);</span>
  <span class="p">};</span>

  <span class="c"># HAProxy service</span>
  <span class="nv">services</span><span class="o">.</span><span class="nv">haproxy</span> <span class="o">=</span> <span class="p">{</span>
    <span class="nv">enable</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
    <span class="nv">config</span> <span class="o">=</span> <span class="s2">''</span><span class="err">
</span><span class="s2">      global</span><span class="err">
</span><span class="s2">        log stdout format raw local0</span><span class="err">
</span><span class="s2">        maxconn 2000</span><span class="err">

</span><span class="s2">      defaults</span><span class="err">
</span><span class="s2">        log global</span><span class="err">
</span><span class="s2">        mode http</span><span class="err">
</span><span class="s2">        option httplog</span><span class="err">
</span><span class="s2">        option dontlognull</span><span class="err">
</span><span class="s2">        option forwardfor except 127.0.0.1</span><span class="err">
</span><span class="s2">        timeout connect 5s</span><span class="err">
</span><span class="s2">        timeout client 30s</span><span class="err">
</span><span class="s2">        timeout server 30s</span><span class="err">
</span><span class="s2">        retries 3</span><span class="err">

</span><span class="s2">      frontend http_in</span><span class="err">
</span><span class="s2">        bind *:80</span><span class="err">
</span><span class="s2">        acl acme_challenge path_beg /.well-known/acme-challenge/</span><span class="err">
</span><span class="s2">        use_backend acme_backend if acme_challenge</span><span class="err">
</span><span class="s2">        acl host_zt hdr(host) -i stephen.zerotier</span><span class="err">
</span><span class="s2">        </span><span class="si">${</span><span class="nv">aclLines</span><span class="si">}</span><span class="err">
</span><span class="s2">        use_backend something_one_maikeladas_es_app if host_zt</span><span class="err">
</span><span class="s2">        </span><span class="si">${</span><span class="nv">redirectLines</span><span class="si">}</span><span class="err">
</span><span class="s2">        default_backend not_found</span><span class="err">

</span><span class="s2">      frontend https_in</span><span class="err">
</span><span class="s2">        bind *:443 ssl </span><span class="si">${</span><span class="nv">crtFiles</span><span class="si">}</span><span class="err">
</span><span class="s2">        mode http</span><span class="err">
</span><span class="s2">        acl acme_challenge path_beg /.well-known/acme-challenge/</span><span class="err">
</span><span class="s2">        </span><span class="si">${</span><span class="nv">aclLines</span><span class="si">}</span><span class="err">
</span><span class="s2">        use_backend acme_backend if acme_challenge</span><span class="err">
</span><span class="s2">        </span><span class="si">${</span><span class="nv">backendLines</span><span class="si">}</span><span class="err">
</span><span class="s2">        default_backend not_found</span><span class="err">

</span><span class="s2">      backend acme_backend</span><span class="err">
</span><span class="s2">        mode http</span><span class="err">
</span><span class="s2">        server local_acme 127.0.0.1:8081</span><span class="err">

</span><span class="s2">      </span><span class="si">${</span><span class="nv">backendDefs</span><span class="si">}</span><span class="err">

</span><span class="s2">      http-errors customerrors</span><span class="err">
</span><span class="s2">        errorfile 503 /etc/haproxy/errorfiles/503.http</span><span class="err">

</span><span class="s2">      backend not_found</span><span class="err">
</span><span class="s2">        mode http</span><span class="err">
</span><span class="s2">        errorfiles customerrors</span><span class="err">
</span><span class="s2">    ''</span><span class="p">;</span>
    <span class="nv">user</span> <span class="o">=</span> <span class="s2">"haproxy"</span><span class="p">;</span>
    <span class="nv">group</span> <span class="o">=</span> <span class="s2">"haproxy"</span><span class="p">;</span>
  <span class="p">};</span>

  <span class="nv">environment</span><span class="o">.</span><span class="nv">etc</span><span class="o">.</span><span class="s2">"haproxy/errorfiles/503.http"</span><span class="o">.</span><span class="nv">text</span> <span class="o">=</span> <span class="s2">''</span><span class="err">
</span><span class="s2">    HTTP/1.1 503 Service Unavailable</span><span class="err">
</span><span class="s2">    Cache-Control: no-cache</span><span class="err">
</span><span class="s2">    Connection: close</span><span class="err">
</span><span class="s2">    Content-Type: text/html</span><span class="err">
</span><span class="s2">    </span><span class="si">${</span><span class="kr">builtins</span><span class="o">.</span><span class="nv">readFile</span> <span class="sx">./haproxy-error-503.html</span><span class="si">}</span><span class="err">
</span><span class="s2">  ''</span><span class="p">;</span>

  <span class="c"># Local HTTP server to serve ACME challenges</span>
  <span class="nv">systemd</span><span class="o">.</span><span class="nv">services</span><span class="o">.</span><span class="nv">acme-challenge-server</span> <span class="o">=</span> <span class="p">{</span>
    <span class="nv">description</span> <span class="o">=</span> <span class="s2">"Serve Let's Encrypt challenges for HAProxy"</span><span class="p">;</span>
    <span class="nv">wantedBy</span> <span class="o">=</span> <span class="p">[</span> <span class="s2">"multi-user.target"</span> <span class="p">];</span>
    <span class="nv">serviceConfig</span> <span class="o">=</span> <span class="p">{</span>
      <span class="nv">ExecStart</span> <span class="o">=</span> <span class="s2">"</span><span class="si">${</span><span class="nv">pkgs</span><span class="o">.</span><span class="nv">python3</span><span class="si">}</span><span class="s2">/bin/python3 -m http.server 8081 --directory /var/lib/acme/acme-challenge"</span><span class="p">;</span>
      <span class="nv">Restart</span> <span class="o">=</span> <span class="s2">"always"</span><span class="p">;</span>
    <span class="p">};</span>
  <span class="p">};</span>
<span class="p">}</span>
</code></pre></div></div>

<h1 id="your-laptop-or-other-pc-configuration-to-be-accessible">Your laptop or other PC configuration to be accessible</h1>

<p>Assuming you use Zerotier (is free) and have it in the same network as the server (I do) and you know the IP or domain name if you have it in /etc/hosts (I do but I prefer to use IPs). Notice how I’ve limited the listening interfaces to that one of Zerotier only.</p>

<p>Of course import this file in your configuration for that machine. I call it <code class="language-plaintext highlighter-rouge">haproxy-redirect.nix</code> to make it clear what the nix contains.</p>

<div class="language-nix highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span> <span class="nv">config</span><span class="p">,</span> <span class="nv">pkgs</span><span class="p">,</span> <span class="o">...</span> <span class="p">}:</span>
<span class="p">{</span>
  <span class="c"># HAProxy service</span>
  <span class="nv">services</span><span class="o">.</span><span class="nv">haproxy</span> <span class="o">=</span> <span class="p">{</span>
    <span class="nv">enable</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
    <span class="nv">config</span> <span class="o">=</span> <span class="s2">''</span><span class="err">
</span><span class="s2">      global</span><span class="err">
</span><span class="s2">        log stdout format raw local0</span><span class="err">
</span><span class="s2">        maxconn 2000</span><span class="err">

</span><span class="s2">      defaults</span><span class="err">
</span><span class="s2">        log global</span><span class="err">
</span><span class="s2">        mode http</span><span class="err">
</span><span class="s2">        option httplog</span><span class="err">
</span><span class="s2">        option dontlognull</span><span class="err">
</span><span class="s2">        option forwardfor except 127.0.0.1</span><span class="err">
</span><span class="s2">        timeout connect 5s</span><span class="err">
</span><span class="s2">        timeout client 30s</span><span class="err">
</span><span class="s2">        timeout server 30s</span><span class="err">
</span><span class="s2">        retries 3</span><span class="err">

</span><span class="s2">      frontend local_http</span><span class="err">
</span><span class="s2">        bind thinkpad.zerotier:8080</span><span class="err">
</span><span class="s2">        default_backend phoenix_app</span><span class="err">

</span><span class="s2">      backend phoenix_app</span><span class="err">
</span><span class="s2">        server phoenix_1 127.0.0.1:4000 check inter 2s fall 3 rise 2</span><span class="err">
</span><span class="s2">        errorfile 503 /etc/haproxy/errorfiles/503.http</span><span class="err">
</span><span class="s2">    ''</span><span class="p">;</span>
    <span class="nv">user</span> <span class="o">=</span> <span class="s2">"haproxy"</span><span class="p">;</span>
    <span class="nv">group</span> <span class="o">=</span> <span class="s2">"haproxy"</span><span class="p">;</span>
  <span class="p">};</span>

  <span class="nv">environment</span><span class="o">.</span><span class="nv">etc</span><span class="o">.</span><span class="s2">"haproxy/errorfiles/503.http"</span><span class="o">.</span><span class="nv">text</span> <span class="o">=</span> <span class="s2">''</span><span class="err">
</span><span class="s2">    HTTP/1.1 503 Service Unavailable</span><span class="err">
</span><span class="s2">    Cache-Control: no-cache</span><span class="err">
</span><span class="s2">    Connection: close</span><span class="err">
</span><span class="s2">    Content-Type: text/html</span><span class="err">
</span><span class="s2">    </span><span class="si">${</span><span class="kr">builtins</span><span class="o">.</span><span class="nv">readFile</span> <span class="sx">./haproxy-error-503.html</span><span class="si">}</span><span class="err">
</span><span class="s2">  ''</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<h2 id="the-default-503-error-file">The default 503 error file</h2>

<p><img src="/assets/images/2025-10-image-1.png" alt="Image" /></p>

<p>All errors I got when I turned off any of them servers were of type 503 so that’s the error I customised. The files is <code class="language-plaintext highlighter-rouge">haproxy-error-503.html</code> and should be in the same folder as the nix configuration. The content is this</p>

<div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;!DOCTYPE html&gt;</span>
<span class="nt">&lt;html</span> <span class="na">lang=</span><span class="s">"en"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;head&gt;</span>
    <span class="nt">&lt;meta</span> <span class="na">charset=</span><span class="s">"utf-8"</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;title&gt;</span>Service Unavailable<span class="nt">&lt;/title&gt;</span>
    <span class="nt">&lt;style&gt;</span>
      <span class="nt">body</span> <span class="p">{</span>
        <span class="nl">font-family</span><span class="p">:</span> <span class="o">-</span><span class="n">apple-system</span><span class="p">,</span> <span class="n">BlinkMacSystemFont</span><span class="p">,</span> <span class="s1">"Segoe UI"</span><span class="p">,</span> <span class="n">Roboto</span><span class="p">,</span> <span class="nb">sans-serif</span><span class="p">;</span>
        <span class="nl">background</span><span class="p">:</span> <span class="nx">#fafafa</span><span class="p">;</span>
        <span class="nl">color</span><span class="p">:</span> <span class="nx">#333</span><span class="p">;</span>
        <span class="nl">margin</span><span class="p">:</span> <span class="m">0</span><span class="p">;</span>
        <span class="nl">display</span><span class="p">:</span> <span class="nb">flex</span><span class="p">;</span>
        <span class="nl">align-items</span><span class="p">:</span> <span class="nb">center</span><span class="p">;</span>
        <span class="nl">justify-content</span><span class="p">:</span> <span class="nb">center</span><span class="p">;</span>
        <span class="nl">height</span><span class="p">:</span> <span class="m">100vh</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="nt">main</span> <span class="p">{</span>
        <span class="nl">text-align</span><span class="p">:</span> <span class="nb">center</span><span class="p">;</span>
        <span class="nl">padding</span><span class="p">:</span> <span class="m">2rem</span><span class="p">;</span>
        <span class="nl">background</span><span class="p">:</span> <span class="nx">white</span><span class="p">;</span>
        <span class="nl">border-radius</span><span class="p">:</span> <span class="m">1rem</span><span class="p">;</span>
        <span class="nl">box-shadow</span><span class="p">:</span> <span class="m">0</span> <span class="m">4px</span> <span class="m">12px</span> <span class="nf">rgba</span><span class="p">(</span><span class="m">0</span><span class="p">,</span><span class="m">0</span><span class="p">,</span><span class="m">0</span><span class="p">,</span><span class="m">0.08</span><span class="p">);</span>
      <span class="p">}</span>
      <span class="nt">h1</span> <span class="p">{</span>
        <span class="nl">font-size</span><span class="p">:</span> <span class="m">2rem</span><span class="p">;</span>
        <span class="nl">margin-bottom</span><span class="p">:</span> <span class="m">0.5rem</span><span class="p">;</span>
        <span class="nl">color</span><span class="p">:</span> <span class="nx">#c0392b</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="nt">p</span> <span class="p">{</span>
        <span class="nl">font-size</span><span class="p">:</span> <span class="m">1rem</span><span class="p">;</span>
        <span class="nl">color</span><span class="p">:</span> <span class="nx">#666</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="nt">&lt;/style&gt;</span>
  <span class="nt">&lt;/head&gt;</span>
  <span class="nt">&lt;body&gt;</span>
    <span class="nt">&lt;main&gt;</span>
      <span class="nt">&lt;h1&gt;</span>503 – Service Unavailable<span class="nt">&lt;/h1&gt;</span>
      <span class="nt">&lt;p&gt;</span>Our server is taking a quick break. Please try again in a moment.<span class="nt">&lt;/p&gt;</span>
    <span class="nt">&lt;/main&gt;</span>
  <span class="nt">&lt;/body&gt;</span>
<span class="nt">&lt;/html&gt;</span>
</code></pre></div></div>

<h1 id="advantages-over-the-pagekite-way">Advantages over the Pagekite way</h1>

<ol>
  <li>HAProxy is a lot more robust.</li>
  <li>Since you’re using already a machine as server and Zerotier for LAN-like communication, this harness precisely all that to make the config a lot simpler.</li>
  <li>SSL renewal bult-in.</li>
  <li>You can just stop the services whenever, the 503 custom-error page will be shown. No need to remember to “sysctl stop whatever”</li>
  <li>Custom error page.</li>
</ol>

  </div>
</article>


      </div>
    </main>

    <footer class="site-footer">
      <div class="wrapper">
        <p>&copy; 2026 Maikelology. All rights reserved.</p>
      </div>
    </footer>
    
    <script>
      // Add anchor links to all headers
      // Use requestAnimationFrame to ensure layout is stable after CSS loads
      function initAnchors() {
        const headers = document.querySelectorAll('h1[id], h2[id], h3[id], h4[id], h5[id], h6[id]');
        
        headers.forEach(function(header) {
          // Check if anchor link already exists
          if (header.querySelector('a.anchor')) {
            return;
          }
          
          const id = header.getAttribute('id');
          if (!id) return;
          
          const anchor = document.createElement('a');
          anchor.href = '#' + id;
          anchor.className = 'anchor';
          anchor.textContent = '#';
          anchor.setAttribute('aria-label', 'Link to this section');
          
          header.insertBefore(anchor, header.firstChild);
        });
      }
      
      // Wait for DOM and ensure layout is stable
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', function() {
          requestAnimationFrame(function() {
            requestAnimationFrame(initAnchors);
          });
        });
      } else {
        requestAnimationFrame(function() {
          requestAnimationFrame(initAnchors);
        });
      }
    </script>
  </body>
</html>
